# Massif：堆分析器

[TOC]

## 概览

> 本文主要参考 [Massif: a heap profiler](https://valgrind.org/docs/manual/ms-manual.html)。

什么是 Massif？

> Massif is a heap profiler. It measures how much heap memory your program uses. 

虽然 Massif 主要是堆分析工具，但是它也可以测量栈的使用大小（默认不会）。

Massif 可以有效地帮助你：

- 它可以加速你的程序：让程序更好地与你的机器的缓存交互，并避免分页。
- 如果您的程序使用大量内存，则会减少耗尽计算机交换空间的机会。
- 某些泄漏是传统泄漏检查器（例如 Memcheck 的）无法检测到的：
  - 这是因为内存实际上并没有丢失，仍然有一个指向它的指针，但它没有被使用。
  - 随着时间的推移，存在此类泄漏的程序可能会不必要地增加其使用的内存量。
  - Massif 可以帮助识别这些泄漏。

为了使用 Massif 工具，在使用 Valgrind 时，需要通过选项 `--tool=massif` 指明。

Massif 可以通过 `--xtree-memory` 选项，提供内存分析的执行树。

## 使用 Massif 和 ms_print

```c
// b.c

#include <stdlib.h>

void g(void)
{
   malloc(4000);
}

void f(void)
{
   malloc(2000);
   g();
}

int main(void)
{
   int i;
   int* a[10];

   for (i = 0; i < 10; i++) {
      a[i] = malloc(1000);
   }

   f();

   g();

   for (i = 0; i < 10; i++) {
      free(a[i]);
   }

   return 0;
}
```

编译代码：

```sh
$ gcc -g b.c -o bc
```

运行命令：

```sh
$ valgrind --tool=massif --time-unit=B ./bc

# 查看文件
$ ms_print massif.out.12345
```

## 输出

我们通过 ms_print 可以得到人类可读的堆分析报告。包括了如下部分：

- 前言
- 采样
- 快照详细信息

### 前言

ms_print 的首个输出部分是前言，表述程序、massif 和 ms_print 是如何调用的：

```sh
--------------------------------------------------------------------------------
Command:            example
Massif arguments:   (none)
ms_print arguments: massif.out.12797
--------------------------------------------------------------------------------
```

**注意：**

- 这个 Command 就是和进程 ps 出来的那个 command 是一样的。

### 采样图

后续部分是整个堆空间的采样情况：

```sh
19.63^                                               ###                      
     |                                               #                        
     |                                               #  ::                    
     |                                               #  : :::                 
     |                                      :::::::::#  : :  ::               
     |                                      :        #  : :  : ::             
     |                                      :        #  : :  : : :::          
     |                                      :        #  : :  : : :  ::        
     |                            :::::::::::        #  : :  : : :  : :::     
     |                            :         :        #  : :  : : :  : :  ::   
     |                        :::::         :        #  : :  : : :  : :  : :: 
     |                     @@@:   :         :        #  : :  : : :  : :  : : @
     |                   ::@  :   :         :        #  : :  : : :  : :  : : @
     |                :::: @  :   :         :        #  : :  : : :  : :  : : @
     |              :::  : @  :   :         :        #  : :  : : :  : :  : : @
     |            ::: :  : @  :   :         :        #  : :  : : :  : :  : : @
     |         :::: : :  : @  :   :         :        #  : :  : : :  : :  : : @
     |       :::  : : :  : @  :   :         :        #  : :  : : :  : :  : : @
     |    :::: :  : : :  : @  :   :         :        #  : :  : : :  : :  : : @
     |  :::  : :  : : :  : @  :   :         :        #  : :  : : :  : :  : : @
   0 +----------------------------------------------------------------------->KB     0                                                                   29.48

Number of snapshots: 25
 Detailed snapshots: [9, 14 (peak), 24]
```

## 多进程 Fork

如果你使用了 Fork，这里会有两种进程：

- 父进程，还是继续采样自己的。
- 子进程，将会继承父进程的堆分析数据，后续采样子进程的。

如果输出文件选项 `--massif-out-file` 不包含 `%p`，那么父子进程的数据将会输出到同一个文件，并且：**这几乎肯定无法被 ms_print 读取**。

## Massif 命令选项
